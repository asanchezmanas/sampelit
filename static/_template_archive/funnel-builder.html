<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Funnel Builder | Samplit</title>

    <!-- Fonts & Tailwind -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        brand: {
                            50: '#ecf3ff',
                            100: '#dde9ff',
                            200: '#c2d6ff',
                            300: '#9cb9ff',
                            400: '#7592ff',
                            500: '#465fff',
                            600: '#3641f5',
                            700: '#2a31d8',
                            800: '#252dae',
                            900: '#262e89',
                            950: '#161950',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Alpine JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Funnel Logic -->
    <script src="/static/js/funnel-builder.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        [x-cloak] {
            display: none !important;
        }

        /* Grid Pattern */
        .grid-pattern {
            background-size: 20px 20px;
            background-image:
                linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        }
    </style>
</head>

<body class="bg-gray-50 h-screen w-screen flex flex-col" x-data="funnelBuilder()">

    <!-- Header -->
    <header class="h-14 border-b border-gray-200 bg-white flex items-center px-4 justify-between z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <a href="/dashboard" class="flex items-center text-gray-500 hover:text-brand-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
            <h1 class="font-bold text-gray-800 tracking-tight">Q4 Marketing Funnel</h1>
            <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">Active</span>
        </div>

        <div class="flex items-center gap-2">
            <button
                class="px-4 py-1.5 bg-brand-600 text-white rounded-md text-sm font-medium hover:bg-brand-700 shadow-sm transition-colors">
                Save Funnel
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">

        <!-- Toolbox (Floating) -->
        <div
            class="absolute left-4 top-4 z-10 bg-white rounded-xl shadow-lg border border-gray-100 p-2 flex flex-col gap-2">
            <template x-for="tool in tools">
                <button @click="addNode(tool.type)"
                    class="w-10 h-10 flex items-center justify-center rounded-lg text-gray-500 hover:bg-brand-50 hover:text-brand-600 transition-colors"
                    :title="tool.label">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        x-html="`<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='${tool.icon}'></path>`"></svg>
                </button>
            </template>
        </div>

        <!-- Properties Panel (Right) -->
        <div class="absolute right-4 top-4 z-10 w-72 bg-white rounded-xl shadow-lg border border-gray-100 p-4 transition-transform duration-300"
            x-show="selectedNode" x-transition:enter="translate-x-full opacity-0"
            x-transition:enter-end="translate-x-0 opacity-100">

            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800">Properties</h3>
                <button @click="selectedNode = null" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <template x-if="selectedNode">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Label</label>
                        <input type="text" x-model="selectedNode.label"
                            class="mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:border-brand-500 focus:outline-none">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Experiment</label>
                        <select class="mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
                            <option>Select Experiment...</option>
                            <option>Example Exp A</option>
                            <option>Example Exp B</option>
                        </select>
                    </div>

                    <div class="pt-4 border-t border-gray-100">
                        <button @click="deleteNode(selectedNode.id)"
                            class="w-full py-2 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100">
                            Delete Node
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- CANVAS -->
        <div class="w-full h-full bg-slate-50 grid-pattern relative overflow-hidden cursor-grab active:cursor-grabbing"
            x-ref="canvas">

            <svg class="absolute inset-0 w-full h-full pointer-events-none z-0">
                <!-- Connections -->
                <template x-for="conn in connections" :key="conn.id">
                    <path :d="getConnectorPath(conn)" stroke="#cbd5e1" stroke-width="2" fill="none"
                        class="transition-all duration-300" />
                </template>

                <!-- Temporary Connection Line -->
                <path :d="getTempConnectionPath()" stroke="#465fff" stroke-width="2" stroke-dasharray="5,5" fill="none"
                    x-show="connectingNode" />
            </svg>

            <!-- NODES -->
            <template x-for="node in nodes" :key="node.id">
                <div class="absolute w-40 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col group hover:shadow-md transition-shadow select-none"
                    :class="{'ring-2 ring-brand-500 border-transparent': selectedNode?.id === node.id}"
                    :style="`transform: translate(${node.x}px, ${node.y}px)`" @mousedown.stop="startDrag($event, node)">

                    <!-- Header -->
                    <div
                        class="px-3 py-2 bg-gray-50 border-b border-gray-100 rounded-t-lg flex items-center justify-between">
                        <span class="text-xs font-semibold text-gray-600 uppercase" x-text="node.type"></span>
                        <div class="w-2 h-2 rounded-full bg-green-400"></div>
                    </div>

                    <!-- Content -->
                    <div class="p-3">
                        <p class="text-sm font-medium text-gray-800 truncate" x-text="node.label"></p>
                    </div>

                    <!-- Connectors -->
                    <div class="absolute -right-3 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-white border border-brand-200 rounded-full flex items-center justify-center cursor-crosshair hover:bg-brand-50 z-10 shadow-sm"
                        @mousedown.stop="startConnection($event, node)" title="Drag">
                        <div class="w-2 h-2 bg-brand-500 rounded-full"></div>
                    </div>

                    <div class="absolute -left-3 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-transparent rounded-full z-0"
                        @mouseup="completeConnection($event, node)">
                    </div>
                </div>
            </template>

        </div>
    </div>

</body>

</html>
