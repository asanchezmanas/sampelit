<!-- 
  Modal Component System
  Usage: Include this partial and use Alpine.js events to open modals
  
  Example:
  <button @click="$dispatch('open-modal', 'create-experiment')">Open</button>
-->

<div x-data="modalSystem()" @open-modal.window="openModal($event.detail)" @close-modal.window="closeModal()">

    <!-- Backdrop -->
    <div x-show="isOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-99998 bg-gray-900/40 backdrop-blur-xl" @click="closeModal()"></div>

    <!-- Create Experiment Modal -->
    <div x-show="activeModal === 'create-experiment'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="fixed inset-0 z-99999 flex items-center justify-center p-4 sm:p-6" @click.self="closeModal()">

        <div class="w-full max-w-[640px] rounded-[48px] bg-white p-12 shadow-2xl dark:bg-[#111621] border border-gray-100 dark:border-white/5 relative overflow-hidden"
            @click.stop>
            <!-- Decorative Glow -->
            <div class="absolute -top-32 -right-32 h-64 w-64 bg-sampelit/5 rounded-full blur-3xl"></div>

            <!-- Header -->
            <div class="flex items-start justify-between mb-10 relative z-10">
                <div>
                    <h3 class="text-3xl font-black tracking-tight text-gray-900 dark:text-white font-display">Initiate
                        New Discovery</h3>
                    <p
                        class="text-[10px] font-black text-gray-400 uppercase tracking-widest mt-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">settings_input_composite</span>
                        Optimization Architecture Protocol
                    </p>
                </div>
                <button @click="closeModal()"
                    class="flex h-12 w-12 items-center justify-center rounded-2xl bg-gray-50 text-gray-400 hover:bg-white hover:text-sampelit shadow-sm transition-all dark:bg-white/5">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Form -->
            <form x-data="experimentForm()" @submit.prevent="submitForm($dispatch)" class="relative z-10">
                <div class="space-y-8">
                    <!-- Name -->
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest">Discovery
                            Identity</label>
                        <div class="relative group">
                            <input type="text" x-model="formData.name" @input="validate('name')"
                                placeholder="e.g., Checkout Funnel Velocity Enhancement"
                                :class="errors.name ? 'border-rose-500 ring-rose-500/10' : 'border-gray-100 focus:border-sampelit focus:ring-sampelit/5'"
                                class="h-14 w-full rounded-2xl border bg-gray-50/50 px-6 text-sm font-bold transition-all focus:bg-white focus:ring-4 dark:bg-white/5 dark:text-white dark:border-white/5">
                            <p x-show="errors.name" x-text="errors.name"
                                class="mt-2 text-[10px] font-black text-rose-500 uppercase tracking-tight"></p>
                        </div>
                    </div>

                    <!-- Target Page -->
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest">Target
                            Deployment URL</label>
                        <div class="relative group">
                            <div class="absolute left-6 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm">
                                https://</div>
                            <input type="text" x-model="formData.page" @input="validate('page')"
                                placeholder="yourdomain.com/path"
                                :class="errors.page ? 'border-rose-500 ring-rose-500/10' : 'border-gray-100 focus:border-sampelit focus:ring-sampelit/5'"
                                class="h-14 w-full rounded-2xl border bg-gray-50/50 pl-20 pr-6 text-sm font-bold transition-all focus:bg-white focus:ring-4 dark:bg-white/5 dark:text-white dark:border-white/5">
                            <p x-show="errors.page" x-text="errors.page"
                                class="mt-2 text-[10px] font-black text-rose-500 uppercase tracking-tight"></p>
                        </div>
                    </div>

                    <!-- Variants & Strategy -->
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest">Variant
                                Count</label>
                            <select x-model="formData.variants"
                                class="h-14 w-full rounded-2xl border border-gray-100 bg-gray-50/50 px-6 text-sm font-black transition-all focus:bg-white focus:ring-4 focus:ring-sampelit/5 focus:border-sampelit dark:bg-white/5 dark:text-white dark:border-white/5">
                                <option value="2">2 (A/B Protocol)</option>
                                <option value="3">3 (A/B/C Power)</option>
                                <option value="4">4 (Multivariate)</option>
                            </select>
                        </div>
                        <div class="space-y-3">
                            <label
                                class="block text-[10px] font-black text-gray-400 uppercase tracking-widest">Inference
                                Engine</label>
                            <select x-model="formData.strategy"
                                class="h-14 w-full rounded-2xl border border-gray-100 bg-gray-50/50 px-6 text-sm font-black transition-all focus:bg-white focus:ring-4 focus:ring-sampelit/5 focus:border-sampelit dark:bg-white/5 dark:text-white dark:border-white/5">
                                <option value="standard">Frequentist (Standard)</option>
                                <option value="bayesian">Bayesian Probability</option>
                                <option value="sequential">Sequential Analysis</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-12 flex items-center justify-end gap-4 pt-8 border-t border-gray-50 dark:border-white/5">
                    <button type="button" @click="closeModal()"
                        class="px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest text-gray-400 hover:text-gray-900 transition-all dark:hover:text-white">
                        Discard
                    </button>
                    <button type="submit" :disabled="Object.values(errors).some(e => e)"
                        class="px-10 py-4 rounded-2xl bg-sampelit text-[10px] font-black uppercase tracking-widest text-white shadow-xl hover:scale-105 active:scale-95 disabled:opacity-30 disabled:pointer-events-none transition-all dark:bg-white dark:text-sampelit">
                        Initiate Discovery
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div x-show="activeModal === 'confirm-delete'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95" class="fixed inset-0 z-99999 flex items-center justify-center p-4"
        @click.self="closeModal()">
        <div class="w-full max-w-md rounded-[48px] bg-white p-12 shadow-2xl dark:bg-[#111621] border border-gray-100 dark:border-white/5 text-center"
            @click.stop>
            <!-- Icon -->
            <div
                class="mx-auto flex h-24 w-24 items-center justify-center rounded-[32px] bg-rose-50 text-rose-500 dark:bg-rose-500/10 mb-8 border border-rose-100 dark:border-rose-500/20 shadow-theme-sm">
                <span class="material-symbols-outlined text-4xl">delete_forever</span>
            </div>

            <!-- Content -->
            <h3 class="text-3xl font-black tracking-tight text-gray-900 dark:text-white font-display">Permanent Deletion
            </h3>
            <p class="mt-4 text-sm text-gray-500 dark:text-gray-400 font-medium leading-relaxed">
                Relinquishing this data will permanently expunge all results, variants, and historical directives.
                Recovery is not architecturally possible.
            </p>

            <!-- Actions -->
            <div class="mt-10 flex flex-col gap-3">
                <button
                    @click="closeModal(); $dispatch('show-toast', { type: 'error', message: 'Directive permanently expunged.' })"
                    class="h-14 w-full rounded-2xl bg-rose-500 text-[10px] font-black uppercase tracking-widest text-white hover:bg-rose-600 transition-all shadow-xl active:scale-95">
                    Confirm Erasure
                </button>
                <button @click="closeModal()"
                    class="h-14 w-full rounded-2xl text-[10px] font-black uppercase tracking-widest text-gray-400 hover:text-gray-900 transition-all dark:hover:text-white">
                    Abort Protocol
                </button>
            </div>
        </div>
    </div>


</div>

<script>
    function modalSystem() {
        return {
            isOpen: false,
            activeModal: null,

            openModal(modalId) {
                this.activeModal = modalId;
                this.isOpen = true;
                document.body.classList.add('overflow-hidden');
            },

            closeModal() {
                this.isOpen = false;
                this.activeModal = null;
                document.body.classList.remove('overflow-hidden');
            }
        };
    }

    function experimentForm() {
        return {
            formData: {
                name: '',
                page: '',
                variants: '2',
                strategy: 'standard'
            },
            errors: {
                name: '',
                page: ''
            },
            validate(field) {
                if (field === 'name') {
                    if (this.formData.name.length < 3) {
                        this.errors.name = 'Label must be at least 3 characters';
                    } else {
                        this.errors.name = '';
                    }
                }
                if (field === 'page') {
                    if (!this.formData.page.startsWith('/')) {
                        this.errors.page = 'Target must begin with /';
                    } else if (this.formData.page.length < 2) {
                        this.errors.page = 'Target is too short';
                    } else {
                        this.errors.page = '';
                    }
                }
            },
            submitForm(dispatch) {
                this.validate('name');
                this.validate('page');

                if (!this.errors.name && !this.errors.page) {
                    dispatch('close-modal');
                    dispatch('show-toast', {
                        type: 'success',
                        message: 'New discovery initiated successfully.'
                    });

                    // Reset form
                    this.formData = { name: '', page: '', variants: '2', strategy: 'standard' };
                }
            }
        };
    }
</script>