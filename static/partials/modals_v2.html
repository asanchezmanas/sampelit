<!-- 
  Modal Component System
  Usage: Include this partial and use Alpine.js events to open modals
  
  Example:
  <button @click="$dispatch('open-modal', 'create-experiment')">Open</button>
-->

<div x-data="modalSystem()" @open-modal.window="openModal($event.detail)" @close-modal.window="closeModal()">

    <!-- Backdrop -->
    <div x-show="isOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-99998 bg-gray-900/50 backdrop-blur-sm" @click="closeModal()"></div>

    <!-- Create Experiment Modal -->
    <div x-show="activeModal === 'create-experiment'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="fixed inset-0 z-99999 flex items-center justify-center p-4 sm:p-6" @click.self="closeModal()">

        <div class="w-full max-w-[580px] rounded-[32px] bg-white p-8 shadow-elevation dark:bg-gray-900 border border-gray-100 dark:border-white/5"
            @click.stop>
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-2xl font-extrabold tracking-tight text-gray-900 dark:text-white font-display">New
                        Discovery</h3>
                    <p class="text-[11px] font-bold text-gray-400 uppercase tracking-widest mt-1">Configure your
                        experiment parameters</p>
                </div>
                <button @click="closeModal()"
                    class="flex h-10 w-10 items-center justify-center rounded-xl bg-gray-50 text-gray-400 hover:bg-brand-50 hover:text-brand-500 transition-all dark:bg-white/5">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- Form -->
            <form x-data="experimentForm()" @submit.prevent="submitForm($dispatch)">
                <div class="space-y-6">
                    <!-- Name -->
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Experiment
                            Name</label>
                        <div class="relative group">
                            <span
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-500 transition-colors">
                                <span class="material-symbols-outlined text-xl">label</span>
                            </span>
                            <input type="text" x-model="formData.name" @input="validate('name')"
                                placeholder="e.g., Homepage Hero Evolution"
                                :class="errors.name ? 'border-red-500 ring-red-500/10' : 'border-gray-100 focus:border-brand-500 focus:ring-brand-500/10'"
                                class="h-12 w-full rounded-2xl border bg-gray-50 pl-12 pr-6 text-sm transition-all focus:bg-white focus:ring-4 dark:bg-white/5 dark:text-white dark:border-white/5">
                            <p x-show="errors.name" x-text="errors.name"
                                class="mt-1 text-[10px] font-bold text-red-500 uppercase tracking-tight"></p>
                        </div>
                    </div>

                    <!-- Target Page -->
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Target
                            Page</label>
                        <div class="relative group">
                            <span
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-500 transition-colors">
                                <span class="material-symbols-outlined text-xl">language</span>
                            </span>
                            <input type="text" x-model="formData.page" @input="validate('page')"
                                placeholder="e.g., /checkout"
                                :class="errors.page ? 'border-red-500 ring-red-500/10' : 'border-gray-100 focus:border-brand-500 focus:ring-brand-500/10'"
                                class="h-12 w-full rounded-2xl border bg-gray-50 pl-12 pr-6 text-sm transition-all focus:bg-white focus:ring-4 dark:bg-white/5 dark:text-white dark:border-white/5">
                            <p x-show="errors.page" x-text="errors.page"
                                class="mt-1 text-[10px] font-bold text-red-500 uppercase tracking-tight"></p>
                        </div>
                    </div>

                    <!-- Variants & Strategy -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Variants</label>
                            <select x-model="formData.variants"
                                class="h-12 w-full rounded-2xl border border-gray-100 bg-gray-50 px-4 text-sm font-bold transition-all focus:bg-white focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 dark:bg-white/5 dark:text-white dark:border-white/5">
                                <option value="2">2 (A/B)</option>
                                <option value="3">3 (A/B/C)</option>
                                <option value="4">4 (Multivariate)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Strategy</label>
                            <select x-model="formData.strategy"
                                class="h-12 w-full rounded-2xl border border-gray-100 bg-gray-50 px-4 text-sm font-bold transition-all focus:bg-white focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 dark:bg-white/5 dark:text-white dark:border-white/5">
                                <option value="standard">Standard</option>
                                <option value="bayesian">Bayesian Engine</option>
                                <option value="sequential">Sequential Test</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-10 flex items-center justify-end gap-3 pt-6 border-t border-gray-50 dark:border-white/5">
                    <button type="button" @click="closeModal()"
                        class="px-6 py-3 rounded-xl border border-gray-100 bg-white text-sm font-bold text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-all dark:bg-transparent dark:border-white/5 dark:text-gray-400 dark:hover:text-white">
                        Discard
                    </button>
                    <button type="submit" :disabled="Object.values(errors).some(e => e)"
                        class="px-8 py-3 rounded-xl bg-gray-900 text-sm font-bold text-white shadow-lg hover:bg-black hover:shadow-xl disabled:opacity-30 disabled:pointer-events-none transition-all dark:bg-white dark:text-gray-900">
                        Launch Discovery
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div x-show="activeModal === 'confirm-delete'" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95" class="fixed inset-0 z-99999 flex items-center justify-center p-4"
        @click.self="closeModal()">
        <div class="w-full max-w-md rounded-[32px] bg-white p-8 shadow-elevation dark:bg-gray-900 border border-gray-100 dark:border-white/5"
            @click.stop>
            <!-- Icon -->
            <div class="mx-auto flex h-20 w-20 items-center justify-center rounded-[32px] bg-red-50 dark:bg-red-500/10">
                <span class="material-symbols-outlined text-4xl text-red-500">delete_forever</span>
            </div>

            <!-- Content -->
            <div class="mt-6 text-center">
                <h3 class="text-2xl font-extrabold tracking-tight text-gray-900 dark:text-white font-display">Delete
                    Experiment?</h3>
                <p class="mt-3 text-sm text-gray-500 dark:text-gray-400 leading-relaxed">
                    This will permanently remove all data, variants, and analytics. This action cannot be undone.
                </p>
            </div>

            <!-- Actions -->
            <div class="mt-8 flex flex-col gap-3">
                <button
                    @click="closeModal(); $dispatch('show-toast', { type: 'error', message: 'Experiment deleted permanently.' })"
                    class="w-full rounded-2xl bg-red-500 px-6 py-4 text-sm font-bold text-white hover:bg-red-600 transition-all shadow-lg">
                    Yes, Delete Forever
                </button>
                <button @click="closeModal()"
                    class="w-full rounded-2xl border border-gray-100 bg-white px-6 py-4 text-sm font-bold text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-all dark:bg-transparent dark:border-white/5 dark:text-gray-400 dark:hover:text-white">
                    Cancel
                </button>
            </div>
        </div>
    </div>


</div>

<script>
    function modalSystem() {
        return {
            isOpen: false,
            activeModal: null,

            openModal(modalId) {
                this.activeModal = modalId;
                this.isOpen = true;
                document.body.classList.add('overflow-hidden');
            },

            closeModal() {
                this.isOpen = false;
                this.activeModal = null;
                document.body.classList.remove('overflow-hidden');
            }
        };
    }

    function experimentForm() {
        return {
            formData: {
                name: '',
                page: '',
                variants: '2',
                strategy: 'standard'
            },
            errors: {
                name: '',
                page: ''
            },
            validate(field) {
                if (field === 'name') {
                    if (this.formData.name.length < 3) {
                        this.errors.name = 'Label must be at least 3 characters';
                    } else {
                        this.errors.name = '';
                    }
                }
                if (field === 'page') {
                    if (!this.formData.page.startsWith('/')) {
                        this.errors.page = 'Target must begin with /';
                    } else if (this.formData.page.length < 2) {
                        this.errors.page = 'Target is too short';
                    } else {
                        this.errors.page = '';
                    }
                }
            },
            submitForm(dispatch) {
                this.validate('name');
                this.validate('page');

                if (!this.errors.name && !this.errors.page) {
                    dispatch('close-modal');
                    dispatch('show-toast', {
                        type: 'success',
                        message: 'New discovery initiated successfully.'
                    });

                    // Reset form
                    this.formData = { name: '', page: '', variants: '2', strategy: 'standard' };
                }
            }
        };
    }
</script>